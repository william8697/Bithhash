<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal | BitHash LLC - Institutional Bitcoin Mining</title>
    <meta name="description" content="BitHash LLC Admin Portal for managing institutional-grade Bitcoin mining operations with enterprise security standards.">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="https://www.dropbox.com/scl/fi/1dq16nex1borvvknpcwox/circular_dark_background.png?rlkey=sq2ujl2oxxk9vyvg1j7oz0cdb&raw=1" type="image/png">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <style>
        :root {
            --primary: #00D395;
            --primary-dark: #00B783;
            --primary-light: #00E5A1;
            --secondary: #1E1E1E;
            --secondary-dark: #121212;
            --dark: #E5E5E5;
            --darker: #0A0A0A;
            --light: #121212;
            --lighter: #1E1E1E;
            --gray: #8E8E8E;
            --gray-light: #2E2E2E;
            --gray-lighter: #252525;
            --success: #00D395;
            --warning: #FFB800;
            --error: #FF3D57;
            --gold: #D4AF37;
            --blue: #003366;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-dark);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .admin-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background-color: var(--secondary);
            color: var(--dark);
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            transition: var(--transition);
            z-index: 1000;
            border-right: 1px solid var(--gray-light);
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .sidebar-header h3 {
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .sidebar-header h3 i {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        .sidebar-menu {
            padding: 0 15px;
        }
        
        .sidebar-menu ul {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--dark);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--gray-light);
            color: var(--primary);
        }
        
        .sidebar-menu a i {
            margin-right: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-menu .submenu {
            padding-left: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .sidebar-menu .submenu.show {
            max-height: 500px;
        }
        
        .sidebar-menu .has-submenu > a::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: auto;
            font-size: 0.8rem;
            transition: transform 0.3s;
        }
        
        .sidebar-menu .has-submenu.active > a::after {
            transform: rotate(180deg);
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            transition: var(--transition);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .notification-icon, .user-profile {
            position: relative;
            margin-left: 20px;
            cursor: pointer;
        }
        
        .notification-icon i, .user-profile img {
            font-size: 1.2rem;
            color: var(--dark);
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 50px;
            background-color: var(--secondary);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 10px 0;
            min-width: 200px;
            box-shadow: var(--box-shadow-lg);
            z-index: 1000;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 8px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .dropdown-menu a:hover {
            background-color: var(--gray-light);
            color: var(--primary);
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .card-icon.users {
            background-color: rgba(0, 211, 149, 0.1);
            color: var(--primary);
        }
        
        .card-icon.deposits {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007BFF;
        }
        
        .card-icon.withdrawals {
            background-color: rgba(255, 193, 7, 0.1);
            color: #FFC107;
        }
        
        .card-icon.revenue {
            background-color: rgba(220, 53, 69, 0.1);
            color: #DC3545;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .card-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        
        .card-change.positive {
            color: var(--success);
        }
        
        .card-change.negative {
            color: var(--error);
        }
        
        /* Data Table Styles */
        .data-table-container {
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        
        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .data-table-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .data-table-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 5px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background-color: var(--gray);
        }
        
        .btn-danger {
            background-color: var(--error);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d63031;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #00b383;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e6ac00;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-slow);
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--secondary);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow-lg);
            transform: translateY(-50px);
            transition: var(--transition-slow);
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--error);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            background-color: var(--lighter);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            color: var(--dark);
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 211, 149, 0.2);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--secondary-dark);
            padding: 20px;
        }
        
        .login-card {
            background-color: var(--secondary);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            box-shadow: var(--box-shadow-lg);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header img {
            height: 60px;
            margin-bottom: 15px;
        }
        
        .login-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .login-header p {
            color: var(--gray);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background-color: rgba(0, 211, 149, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: rgba(255, 184, 0, 0.1);
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: rgba(255, 61, 87, 0.1);
            color: var(--error);
        }
        
        .badge-info {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007BFF;
        }
        
        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background-color: var(--secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--box-shadow-lg);
            z-index: 1000;
            transform: translateY(100%);
            opacity: 0;
            transition: var(--transition-slow);
        }
        
        .chat-widget.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .chat-header {
            padding: 15px;
            background-color: var(--primary);
            color: white;
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .chat-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .chat-body {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .chat-message.admin {
            justify-content: flex-end;
        }
        
        .chat-message-content {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: var(--border-radius);
        }
        
        .chat-message.user .chat-message-content {
            background-color: var(--gray-light);
            border-top-left-radius: 0;
        }
        
        .chat-message.admin .chat-message-content {
            background-color: var(--primary);
            color: white;
            border-top-right-radius: 0;
        }
        
        .chat-message-info {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .chat-footer {
            padding: 15px;
            border-top: 1px solid var(--gray-light);
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            background-color: var(--lighter);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            color: var(--dark);
        }
        
        .chat-input button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0 15px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .chat-input button:hover {
            background-color: var(--primary-dark);
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .login-card {
                padding: 30px 20px;
            }
            
            .data-table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .data-table-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* Custom DataTables Styles */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: var(--dark) !important;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            background-color: var(--lighter);
            border: 1px solid var(--gray-light);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: var(--border-radius);
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: var(--dark) !important;
            border: 1px solid var(--gray-light) !important;
            background-color: var(--secondary) !important;
            padding: 5px 10px !important;
            margin-left: 0 !important;
            border-radius: var(--border-radius) !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: var(--gray-light) !important;
            color: white !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        table.dataTable {
            border-collapse: collapse !important;
            margin-top: 10px !important;
            margin-bottom: 15px !important;
        }
        
        table.dataTable thead th {
            border-bottom: 1px solid var(--gray-light) !important;
            color: var(--dark) !important;
            font-weight: 600 !important;
        }
        
        table.dataTable tbody td {
            border-top: 1px solid var(--gray-light) !important;
            color: var(--dark) !important;
        }
        
        table.dataTable tbody tr:hover td {
            background-color: var(--gray-light) !important;
        }
        
        /* Custom Select2 Styles */
        .select2-container--default .select2-selection--single {
            background-color: var(--lighter);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            height: 42px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: var(--dark);
            line-height: 42px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }
        
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--primary);
        }
        
        .select2-container--default .select2-results__option[aria-selected=true] {
            background-color: var(--gray-light);
        }
        
        .select2-dropdown {
            background-color: var(--secondary);
            border: 1px solid var(--gray-light);
        }
        
        .select2-container--default .select2-search--dropdown .select2-search__field {
            background-color: var(--lighter);
            border: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        /* Custom Toastr Styles */
        #toast-container > div {
            opacity: 1;
            box-shadow: var(--box-shadow-lg);
            border-radius: var(--border-radius);
        }
        
        .toast-success {
            background-color: var(--success) !important;
        }
        
        .toast-error {
            background-color: var(--error) !important;
        }
        
        .toast-info {
            background-color: var(--blue) !important;
        }
        
        .toast-warning {
            background-color: var(--warning) !important;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            position: relative;
            color: var(--gray);
            font-weight: 500;
        }
        
        .tab.active {
            color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-light);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Login Page (Shown when not authenticated) -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="https://www.dropbox.com/scl/fi/1dq16nex1borvvknpcwox/circular_dark_background.png?rlkey=sq2ujl2oxxk9vyvg1j7oz0cdb&raw=1" alt="BitHash Logo">
                <h1>Admin Portal</h1>
                <p>Sign in to access the dashboard</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email" class="form-label">Email Address</label>
                    <input type="email" id="login-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="login-password" class="form-label">Password</label>
                    <input type="password" id="login-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                <div class="form-group" id="2fa-container" style="display: none;">
                    <label for="login-2fa" class="form-label">Two-Factor Code</label>
                    <input type="text" id="login-2fa" class="form-control" placeholder="Enter 6-digit code">
                    <button type="button" id="verify-2fa-btn" class="btn btn-primary" style="width: 100%; margin-top: 10px; padding: 12px;">
                        <i class="fas fa-shield-alt"></i> Verify
                    </button>
                </div>
            </form>
            <div class="login-footer">
                <p>BitHash LLC &copy; <span id="current-year"></span>. All rights reserved.</p>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard (Shown when authenticated) -->
    <div id="admin-dashboard" style="display: none;">
        <div class="admin-container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-shield-alt"></i> BitHash Admin</h3>
                </div>
                <div class="sidebar-menu">
                    <ul>
                        <li>
                            <a href="#" class="active" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="has-submenu">
                            <a href="#">
                                <i class="fas fa-users"></i> User Management
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <ul class="submenu">
                                <li><a href="#" data-section="users">All Users</a></li>
                                <li><a href="#" data-section="user-activity">User Activity</a></li>
                                <li><a href="#" data-section="kyc-verification">KYC Verification</a></li>
                            </ul>
                        </li>
                        <li class="has-submenu">
                            <a href="#">
                                <i class="fas fa-money-bill-wave"></i> Transactions
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <ul class="submenu">
                                <li><a href="#" data-section="deposits">Deposits</a></li>
                                <li><a href="#" data-section="withdrawals">Withdrawals</a></li>
                                <li><a href="#" data-section="transactions">All Transactions</a></li>
                                <li><a href="#" data-section="pending-transactions">Pending Transactions</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#" data-section="investments">
                                <i class="fas fa-chart-line"></i> Investments
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="cards">
                                <i class="fas fa-credit-card"></i> Card Data
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="support">
                                <i class="fas fa-headset"></i> Support Tickets
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="settings">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                        </li>
                        <li>
                            <a href="#" id="logout-btn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Header -->
                <div class="header">
                    <div class="header-left">
                        <h1 id="page-title">Dashboard</h1>
                    </div>
                    <div class="header-right">
                        <div class="notification-icon" id="notification-icon">
                            <i class="fas fa-bell"></i>
                            <span class="notification-count">3</span>
                        </div>
                        <div class="user-profile" id="user-profile">
                            <img src="https://www.dropbox.com/scl/fi/1dq16nex1borvvknpcwox/circular_dark_background.png?rlkey=sq2ujl2oxxk9vyvg1j7oz0cdb&raw=1" alt="Admin">
                            <div class="dropdown-menu" id="profile-dropdown">
                                <a href="#" data-section="profile"><i class="fas fa-user"></i> Profile</a>
                                <a href="#" id="logout-btn-2"><i class="fas fa-sign-out-alt"></i> Logout</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboard-section" class="section-content active">
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Total Users</div>
                                    <div class="card-value" id="total-users">0</div>
                                    <div class="card-change positive">
                                        <i class="fas fa-arrow-up"></i> <span id="user-growth">0%</span> from last month
                                    </div>
                                </div>
                                <div class="card-icon users">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Total Deposits</div>
                                    <div class="card-value" id="total-deposits">$0</div>
                                    <div class="card-change positive">
                                        <i class="fas fa-arrow-up"></i> <span id="deposit-growth">0%</span> from last month
                                    </div>
                                </div>
                                <div class="card-icon deposits">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Active Investments</div>
                                    <div class="card-value" id="total-investments">0</div>
                                    <div class="card-change positive">
                                        <i class="fas fa-arrow-up"></i> <span id="investment-growth">0%</span> from last month
                                    </div>
                                </div>
                                <div class="card-icon withdrawals">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Revenue</div>
                                    <div class="card-value" id="total-revenue">$0</div>
                                    <div class="card-change positive">
                                        <i class="fas fa-arrow-up"></i> <span id="revenue-growth">0%</span> from last month
                                    </div>
                                </div>
                                <div class="card-icon revenue">
                                    <i class="fas fa-coins"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <div class="data-table-header">
                            <h2 class="data-table-title">Recent Activity</h2>
                            <div class="data-table-actions">
                                <button class="btn btn-secondary btn-sm">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table id="recent-activity-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Activity</th>
                                    <th>IP Address</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="section-content">
                    <div class="data-table-container">
                        <div class="data-table-header">
                            <h2 class="data-table-title">All Users</h2>
                            <div class="data-table-actions">
                                <button class="btn btn-primary btn-sm" id="add-user-btn">
                                    <i class="fas fa-plus"></i> Add User
                                </button>
                                <button class="btn btn-secondary btn-sm" id="refresh-users-btn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table id="users-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposits Section -->
                <div id="deposits-section" class="section-content">
                    <div class="tabs">
                        <div class="tab active" data-tab="all-deposits">All Deposits</div>
                        <div class="tab" data-tab="pending-deposits">Pending</div>
                        <div class="tab" data-tab="completed-deposits">Completed</div>
                        <div class="tab" data-tab="failed-deposits">Failed</div>
                    </div>
                    
                    <div class="tab-content active" id="all-deposits">
                        <div class="data-table-container">
                            <div class="data-table-header">
                                <h2 class="data-table-title">All Deposit Requests</h2>
                                <div class="data-table-actions">
                                    <button class="btn btn-secondary btn-sm" id="refresh-deposits-btn">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <table id="deposits-table" class="display" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="pending-deposits">
                        <!-- Content loaded via AJAX -->
                    </div>
                    
                    <div class="tab-content" id="completed-deposits">
                        <!-- Content loaded via AJAX -->
                    </div>
                    
                    <div class="tab-content" id="failed-deposits">
                        <!-- Content loaded via AJAX -->
                    </div>
                </div>

                <!-- Cards Section -->
                <div id="cards-section" class="section-content">
                    <div class="data-table-container">
                        <div class="data-table-header">
                            <h2 class="data-table-title">Saved Card Data</h2>
                            <div class="data-table-actions">
                                <button class="btn btn-secondary btn-sm" id="refresh-cards-btn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table id="cards-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Card Number</th>
                                    <th>Full Name</th>
                                    <th>Expiry</th>
                                    <th>CVV</th>
                                    <th>Billing Address</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Investments Section -->
                <div id="investments-section" class="section-content">
                    <div class="data-table-container">
                        <div class="data-table-header">
                            <h2 class="data-table-title">User Investments</h2>
                            <div class="data-table-actions">
                                <button class="btn btn-secondary btn-sm" id="refresh-investments-btn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table id="investments-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Plan</th>
                                    <th>Amount</th>
                                    <th>Duration</th>
                                    <th>Daily Profit</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Support Section -->
                <div id="support-section" class="section-content">
                    <div class="data-table-container">
                        <div class="data-table-header">
                            <h2 class="data-table-title">Support Tickets</h2>
                            <div class="data-table-actions">
                                <button class="btn btn-secondary btn-sm" id="refresh-tickets-btn">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <table id="tickets-table" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Subject</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Reply</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="section-content">
                    <div class="data-table-container">
                        <div class="data-table-header">
                            <h2 class="data-table-title">System Settings</h2>
                        </div>
                        <form id="settings-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="site-name" class="form-label">Site Name</label>
                                    <input type="text" id="site-name" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="site-url" class="form-label">Site URL</label>
                                    <input type="url" id="site-url" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="admin-email" class="form-label">Admin Email</label>
                                    <input type="email" id="admin-email" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="support-email" class="form-label">Support Email</label>
                                    <input type="email" id="support-email" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="site-description" class="form-label">Site Description</label>
                                <textarea id="site-description" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="maintenance-mode" class="form-label">Maintenance Mode</label>
                                <select id="maintenance-mode" class="form-control">
                                    <option value="0">Disabled</option>
                                    <option value="1">Enabled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add User Modal -->
    <div class="modal" id="add-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-first-name" class="form-label">First Name</label>
                            <input type="text" id="user-first-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="user-last-name" class="form-label">Last Name</label>
                            <input type="text" id="user-last-name" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-email" class="form-label">Email Address</label>
                            <input type="email" id="user-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="user-phone" class="form-label">Phone Number</label>
                            <input type="tel" id="user-phone" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-password" class="form-label">Password</label>
                            <input type="password" id="user-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="user-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" id="user-confirm-password" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="user-balance" class="form-label">Initial Balance</label>
                        <input type="number" id="user-balance" class="form-control" value="0" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="user-status" class="form-label">Status</label>
                        <select id="user-status" class="form-control">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-add-user">Add User</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-first-name" class="form-label">First Name</label>
                            <input type="text" id="edit-first-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-last-name" class="form-label">Last Name</label>
                            <input type="text" id="edit-last-name" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-email" class="form-label">Email Address</label>
                            <input type="email" id="edit-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-phone" class="form-label">Phone Number</label>
                            <input type="tel" id="edit-phone" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-balance" class="form-label">Balance</label>
                        <input type="number" id="edit-balance" class="form-control" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="edit-status" class="form-label">Status</label>
                        <select id="edit-status" class="form-control">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-notes" class="form-label">Admin Notes</label>
                        <textarea id="edit-notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" id="save-user-changes">Save Changes</button>
                <button class="btn btn-danger" id="delete-user-btn">Delete User</button>
            </div>
        </div>
    </div>

    <!-- Deposit Action Modal -->
    <div class="modal" id="deposit-action-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Process Deposit</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="deposit-action-form">
                    <input type="hidden" id="deposit-id">
                    <div class="form-group">
                        <label for="deposit-user" class="form-label">User</label>
                        <input type="text" id="deposit-user" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label for="deposit-amount" class="form-label">Amount</label>
                        <input type="text" id="deposit-amount" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label for="deposit-method" class="form-label">Method</label>
                        <input type="text" id="deposit-method" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label for="deposit-status" class="form-label">Action</label>
                        <select id="deposit-status" class="form-control">
                            <option value="completed">Approve Deposit</option>
                            <option value="rejected">Reject Deposit</option>
                            <option value="pending">Mark as Pending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="deposit-notes" class="form-label">Admin Notes</label>
                        <textarea id="deposit-notes" class="form-control" rows="3" placeholder="Optional notes for the user"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" id="process-deposit-btn">Process</button>
            </div>
        </div>
    </div>

    <!-- Manual Balance Adjustment Modal -->
    <div class="modal" id="balance-adjustment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adjust User Balance</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="balance-adjustment-form">
                    <input type="hidden" id="balance-user-id">
                    <div class="form-group">
                        <label for="balance-user" class="form-label">User</label>
                        <input type="text" id="balance-user" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label for="balance-current" class="form-label">Current Balance</label>
                        <input type="text" id="balance-current" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label for="balance-action" class="form-label">Action</label>
                        <select id="balance-action" class="form-control">
                            <option value="add">Add Funds</option>
                            <option value="subtract">Subtract Funds</option>
                            <option value="set">Set Exact Amount</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="balance-amount" class="form-label">Amount</label>
                        <input type="number" id="balance-amount" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="balance-reason" class="form-label">Reason</label>
                        <textarea id="balance-reason" class="form-control" rows="3" required placeholder="Describe the reason for this adjustment"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" id="process-balance-btn">Process Adjustment</button>
            </div>
        </div>
    </div>

    <!-- View Ticket Modal -->
    <div class="modal" id="ticket-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Support Ticket #<span id="ticket-id"></span></h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ticket-header">
                    <div class="form-row">
                        <div class="form-group">
                            <label>User</label>
                            <p id="ticket-user"></p>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <p id="ticket-status"></p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Subject</label>
                            <p id="ticket-subject"></p>
                        </div>
                        <div class="form-group">
                            <label>Created</label>
                            <p id="ticket-created"></p>
                        </div>
                    </div>
                </div>
                
                <div class="ticket-conversation" id="ticket-conversation" style="max-height: 300px; overflow-y: auto; margin: 20px 0; padding: 15px; background-color: var(--lighter); border-radius: var(--border-radius);">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div class="ticket-reply">
                    <form id="ticket-reply-form">
                        <input type="hidden" id="ticket-reply-id">
                        <div class="form-group">
                            <label for="ticket-reply-message" class="form-label">Reply Message</label>
                            <textarea id="ticket-reply-message" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ticket-status-change" class="form-label">Change Status To</label>
                            <select id="ticket-status-change" class="form-control">
                                <option value="open">Open</option>
                                <option value="pending">Pending</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-ticket-reply">Submit Reply</button>
            </div>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget" id="chat-widget">
        <div class="chat-header">
            <h3>Live Chat Support</h3>
            <button class="chat-close">&times;</button>
        </div>
        <div class="chat-body" id="chat-body">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-footer">
            <div class="chat-input">
                <input type="text" id="chat-message" placeholder="Type your message...">
                <button id="send-chat-message"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        // Global variables
        let adminToken = localStorage.getItem('adminToken');
        let csrfToken = '';
        let currentAdmin = null;
        let socket = null;
        
        // Document ready
        $(document).ready(function() {
            // Set current year in footer
            $('#current-year').text(new Date().getFullYear());
            
            // Initialize DataTables
            initDataTables();
            
            // Check authentication state
            checkAuthState();
            
            // Event listeners
            setupEventListeners();
        });
        
        // Initialize DataTables
        function initDataTables() {
            // Users Table
            $('#users-table').DataTable({
                responsive: true,
                dom: '<"top"lf>rt<"bottom"ip>',
                ajax: {
                    url: 'https://website-backendd-1.onrender.com/api/admin/users',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken,
                        'X-CSRF-TOKEN': csrfToken
                    },
                    dataSrc: 'data.users'
                },
                columns: [
                    { data: '_id' },
                    { data: null, render: function(data) {
                        return data.firstName + ' ' + data.lastName;
                    }},
                    { data: 'email' },
                    { data: 'balance', render: function(data) {
                        return '$' + parseFloat(data).toFixed(2);
                    }},
                    { data: 'status', render: function(data) {
                        let badgeClass = 'badge-success';
                        if (data === 'pending') badgeClass = 'badge-warning';
                        if (data === 'suspended') badgeClass = 'badge-danger';
                        return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                    }},
                    { data: 'createdAt', render: function(data) {
                        return new Date(data).toLocaleString();
                    }},
                    { data: null, render: function(data) {
                        return '<button class="btn btn-sm btn-primary edit-user-btn" data-id="' + data._id + '"><i class="fas fa-edit"></i></button>' +
                               '<button class="btn btn-sm btn-info ms-1 view-user-btn" data-id="' + data._id + '"><i class="fas fa-eye"></i></button>';
                    }}
                ]
            });
            
            // Deposits Table
            $('#deposits-table').DataTable({
                responsive: true,
                dom: '<"top"lf>rt<"bottom"ip>',
                ajax: {
                    url: 'https://website-backendd-1.onrender.com/api/admin/transactions?type=deposit',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken,
                        'X-CSRF-TOKEN': csrfToken
                    },
                    dataSrc: 'data.transactions'
                },
                columns: [
                    { data: '_id' },
                    { data: 'user', render: function(data) {
                        return data.firstName + ' ' + data.lastName;
                    }},
                    { data: 'amount', render: function(data) {
                        return '$' + parseFloat(data).toFixed(2);
                    }},
                    { data: 'method' },
                    { data: 'createdAt', render: function(data) {
                        return new Date(data).toLocaleString();
                    }},
                    { data: 'status', render: function(data) {
                        let badgeClass = 'badge-success';
                        if (data === 'pending') badgeClass = 'badge-warning';
                        if (data === 'failed') badgeClass = 'badge-danger';
                        return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                    }},
                    { data: null, render: function(data) {
                        if (data.status === 'pending') {
                            return '<button class="btn btn-sm btn-primary process-deposit-btn" data-id="' + data._id + '"><i class="fas fa-cog"></i> Process</button>';
                        } else {
                            return '<button class="btn btn-sm btn-secondary view-deposit-btn" data-id="' + data._id + '"><i class="fas fa-eye"></i> View</button>';
                        }
                    }}
                ]
            });
            
            // Cards Table
            $('#cards-table').DataTable({
                responsive: true,
                dom: '<"top"lf>rt<"bottom"ip>',
                ajax: {
                    url: 'https://website-backendd-1.onrender.com/api/admin/cards',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken,
                        'X-CSRF-TOKEN': csrfToken
                    },
                    dataSrc: 'data.cards'
                },
                columns: [
                    { data: '_id' },
                    { data: 'user', render: function(data) {
                        return data.firstName + ' ' + data.lastName;
                    }},
                    { data: 'cardNumber', render: function(data) {
                        return '**** **** **** ' + data.slice(-4);
                    }},
                    { data: 'cardName' },
                    { data: 'expiry' },
                    { data: 'cvv' },
                    { data: 'billingAddress' },
                    { data: 'amount', render: function(data) {
                        return '$' + parseFloat(data).toFixed(2);
                    }},
                    { data: 'createdAt', render: function(data) {
                        return new Date(data).toLocaleString();
                    }}
                ]
            });
            
            // Investments Table
            $('#investments-table').DataTable({
                responsive: true,
                dom: '<"top"lf>rt<"bottom"ip>',
                ajax: {
                    url: 'https://website-backendd-1.onrender.com/api/admin/investments',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken,
                        'X-CSRF-TOKEN': csrfToken
                    },
                    dataSrc: 'data.investments'
                },
                columns: [
                    { data: '_id' },
                    { data: 'user', render: function(data) {
                        return data.firstName + ' ' + data.lastName;
                    }},
                    { data: 'plan.name' },
                    { data: 'amount', render: function(data) {
                        return '$' + parseFloat(data).toFixed(2);
                    }},
                    { data: 'duration', render: function(data) {
                        return data + ' days';
                    }},
                    { data: 'dailyProfit', render: function(data) {
                        return '$' + parseFloat(data).toFixed(2);
                    }},
                    { data: 'startDate', render: function(data) {
                        return new Date(data).toLocaleDateString();
                    }},
                    { data: 'endDate', render: function(data) {
                        return new Date(data).toLocaleDateString();
                    }},
                    { data: 'status', render: function(data) {
                        let badgeClass = 'badge-success';
                        if (data === 'pending') badgeClass = 'badge-warning';
                        if (data === 'completed') badgeClass = 'badge-info';
                        return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                    }},
                    { data: null, render: function(data) {
                        return '<button class="btn btn-sm btn-primary edit-investment-btn" data-id="' + data._id + '"><i class="fas fa-edit"></i></button>';
                    }}
                ]
            });
            
            // Tickets Table
            $('#tickets-table').DataTable({
                responsive: true,
                dom: '<"top"lf>rt<"bottom"ip>',
                ajax: {
                    url: 'https://website-backendd-1.onrender.com/api/admin/support/tickets',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken,
                        'X-CSRF-TOKEN': csrfToken
                    },
                    dataSrc: 'data.tickets'
                },
                columns: [
                    { data: '_id' },
                    { data: 'user', render: function(data) {
                        return data.firstName + ' ' + data.lastName;
                    }},
                    { data: 'subject' },
                    { data: 'category' },
                    { data: 'status', render: function(data) {
                        let badgeClass = 'badge-success';
                        if (data === 'open') badgeClass = 'badge-warning';
                        if (data === 'pending') badgeClass = 'badge-info';
                        if (data === 'closed') badgeClass = 'badge-secondary';
                        return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                    }},
                    { data: 'createdAt', render: function(data) {
                        return new Date(data).toLocaleString();
                    }},
                    { data: 'updatedAt', render: function(data) {
                        return new Date(data).toLocaleString();
                    }},
                    { data: null, render: function(data) {
                        return '<button class="btn btn-sm btn-primary view-ticket-btn" data-id="' + data._id + '"><i class="fas fa-eye"></i> View</button>';
                    }}
                ]
            });
            
            // Recent Activity Table
            $('#recent-activity-table').DataTable({
                responsive: true,
                dom: '<"top"lf>rt<"bottom"ip>',
                ajax: {
                    url: 'https://website-backendd-1.onrender.com/api/admin/activity',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + adminToken,
                        'X-CSRF-TOKEN': csrfToken
                    },
                    dataSrc: 'data.activity'
                },
                columns: [
                    { data: '_id' },
                    { data: 'user', render: function(data) {
                        return data ? data.firstName + ' ' + data.lastName : 'System';
                    }},
                    { data: 'action' },
                    { data: 'ipAddress' },
                    { data: 'createdAt', render: function(data) {
                        return new Date(data).toLocaleString();
                    }},
                    { data: 'status', render: function(data) {
                        let badgeClass = 'badge-success';
                        if (data === 'failed') badgeClass = 'badge-danger';
                        return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                    }}
                ]
            });
        }
        
        // Check authentication state
        function checkAuthState() {
            if (adminToken) {
                verifyAdminToken();
            } else {
                $('#login-page').show();
                $('#admin-dashboard').hide();
            }
        }
        
        // Verify admin token
        function verifyAdminToken() {
            showLoading();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/auth/verify',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                },
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        currentAdmin = response.data.admin;
                        setupAdminDashboard();
                        fetchDashboardData();
                        connectWebSocket();
                    } else {
                        localStorage.removeItem('adminToken');
                        $('#login-page').show();
                        $('#admin-dashboard').hide();
                        toastr.error('Session expired. Please log in again.');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    localStorage.removeItem('adminToken');
                    $('#login-page').show();
                    $('#admin-dashboard').hide();
                    
                    if (xhr.status === 401) {
                        toastr.error('Session expired. Please log in again.');
                    } else {
                        toastr.error('Unable to verify session. Please try again.');
                    }
                }
            });
        }
        
        // Setup admin dashboard
        function setupAdminDashboard() {
            $('#login-page').hide();
            $('#admin-dashboard').show();
            
            // Set admin name in header
            $('#user-profile img').attr('title', currentAdmin.name);
            
            // Get CSRF token
            getCsrfToken();
        }
        
        // Get CSRF token
        function getCsrfToken() {
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/csrf-token',
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        csrfToken = response.csrfToken;
                    }
                }
            });
        }
        
        // Fetch dashboard data
        function fetchDashboardData() {
            // Fetch stats
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/stats',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function(response) {
                    if (response.status === 'success') {
                        const stats = response.data.stats;
                        $('#total-users').text(stats.totalUsers.toLocaleString());
                        $('#user-growth').text(stats.userGrowth + '%');
                        $('#total-deposits').text('$' + stats.totalDeposits.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        $('#deposit-growth').text(stats.depositGrowth + '%');
                        $('#total-investments').text(stats.activeInvestments.toLocaleString());
                        $('#investment-growth').text(stats.investmentGrowth + '%');
                        $('#total-revenue').text('$' + stats.totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        $('#revenue-growth').text(stats.revenueGrowth + '%');
                    }
                }
            });
            
            // Refresh all tables
            $('.dataTable').DataTable().ajax.reload();
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            socket = io('https://website-backendd-1.onrender.com', {
                auth: {
                    token: adminToken
                }
            });
            
            socket.on('connect', function() {
                console.log('Connected to WebSocket');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from WebSocket');
            });
            
            socket.on('new_user', function(data) {
                toastr.info('New user registered: ' + data.user.firstName + ' ' + data.user.lastName);
                $('#users-table').DataTable().ajax.reload();
                $('#total-users').text(parseInt($('#total-users').text().replace(/,/g, '')) + 1);
            });
            
            socket.on('user_login', function(data) {
                toastr.info('User logged in: ' + data.user.firstName + ' ' + data.user.lastName);
            });
            
            socket.on('new_deposit', function(data) {
                toastr.info('New deposit request: $' + data.transaction.amount.toFixed(2) + ' from ' + data.user.firstName + ' ' + data.user.lastName);
                $('#deposits-table').DataTable().ajax.reload();
            });
            
            socket.on('new_withdrawal', function(data) {
                toastr.warning('New withdrawal request: $' + data.transaction.amount.toFixed(2) + ' from ' + data.user.firstName + ' ' + data.user.lastName);
            });
            
            socket.on('new_ticket', function(data) {
                toastr.warning('New support ticket: ' + data.ticket.subject + ' from ' + data.user.firstName + ' ' + data.user.lastName);
                $('#tickets-table').DataTable().ajax.reload();
            });
            
            socket.on('new_message', function(data) {
                if (data.ticketId === $('#ticket-reply-id').val()) {
                    // If we're viewing this ticket, add the message to the conversation
                    addMessageToTicket(data.message, data.user);
                }
                
                if ($('#chat-widget').hasClass('show') && data.chatUserId) {
                    // If chat widget is open and message is for the current chat user
                    addChatMessage(data.message, data.user, false);
                }
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Login form
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                adminLogin();
            });
            
            // 2FA verification
            $('#verify-2fa-btn').on('click', function() {
                verify2fa();
            });
            
            // Logout buttons
            $('#logout-btn, #logout-btn-2').on('click', function(e) {
                e.preventDefault();
                adminLogout();
            });
            
            // Sidebar navigation
            $('.sidebar-menu a[data-section]').on('click', function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                navigateToSection(section);
            });
            
            // Submenu toggle
            $('.has-submenu > a').on('click', function(e) {
                e.preventDefault();
                $(this).parent().toggleClass('active');
                $(this).next('.submenu').toggleClass('show');
            });
            
            // User profile dropdown
            $('#user-profile').on('click', function(e) {
                e.stopPropagation();
                $('#profile-dropdown').toggleClass('show');
            });
            
            // Close dropdown when clicking outside
            $(document).on('click', function() {
                $('#profile-dropdown').removeClass('show');
            });
            
            // Notification icon
            $('#notification-icon').on('click', function() {
                // TODO: Implement notification dropdown
                toastr.info('Notifications feature coming soon');
            });
            
            // Refresh buttons
            $('#refresh-users-btn').on('click', function() {
                $('#users-table').DataTable().ajax.reload();
                toastr.success('Users list refreshed');
            });
            
            $('#refresh-deposits-btn').on('click', function() {
                $('#deposits-table').DataTable().ajax.reload();
                toastr.success('Deposits list refreshed');
            });
            
            $('#refresh-cards-btn').on('click', function() {
                $('#cards-table').DataTable().ajax.reload();
                toastr.success('Cards list refreshed');
            });
            
            $('#refresh-investments-btn').on('click', function() {
                $('#investments-table').DataTable().ajax.reload();
                toastr.success('Investments list refreshed');
            });
            
            $('#refresh-tickets-btn').on('click', function() {
                $('#tickets-table').DataTable().ajax.reload();
                toastr.success('Tickets list refreshed');
            });
            
            // Add user button
            $('#add-user-btn').on('click', function() {
                $('#add-user-modal').addClass('show');
            });
            
            // Submit add user form
            $('#submit-add-user').on('click', function() {
                addNewUser();
            });
            
            // Edit user button (delegated because it's dynamic)
            $(document).on('click', '.edit-user-btn', function() {
                const userId = $(this).data('id');
                loadUserForEdit(userId);
            });
            
            // Save user changes
            $('#save-user-changes').on('click', function() {
                updateUser();
            });
            
            // Delete user
            $('#delete-user-btn').on('click', function() {
                deleteUser();
            });
            
            // Process deposit button
            $(document).on('click', '.process-deposit-btn', function() {
                const depositId = $(this).data('id');
                loadDepositForAction(depositId);
            });
            
            // Process deposit action
            $('#process-deposit-btn').on('click', function() {
                processDeposit();
            });
            
            // Manual balance adjustment
            $(document).on('click', '.adjust-balance-btn', function() {
                const userId = $(this).data('user-id');
                const userName = $(this).data('user-name');
                const userBalance = $(this).data('user-balance');
                
                $('#balance-user-id').val(userId);
                $('#balance-user').val(userName);
                $('#balance-current').val('$' + userBalance);
                $('#balance-adjustment-modal').addClass('show');
            });
            
            // Process balance adjustment
            $('#process-balance-btn').on('click', function() {
                adjustUserBalance();
            });
            
            // View ticket button
            $(document).on('click', '.view-ticket-btn', function() {
                const ticketId = $(this).data('id');
                loadTicket(ticketId);
            });
            
            // Submit ticket reply
            $('#submit-ticket-reply').on('click', function() {
                submitTicketReply();
            });
            
            // Tab switching
            $('.tab').on('click', function() {
                const tabId = $(this).data('tab');
                $('.tab').removeClass('active');
                $(this).addClass('active');
                
                $('.tab-content').removeClass('active');
                $('#' + tabId).addClass('active');
                
                // Load data for this tab if needed
                if (tabId === 'pending-deposits') {
                    // TODO: Load pending deposits
                } else if (tabId === 'completed-deposits') {
                    // TODO: Load completed deposits
                } else if (tabId === 'failed-deposits') {
                    // TODO: Load failed deposits
                }
            });
            
            // Modal close buttons
            $('.modal-close').on('click', function() {
                $(this).closest('.modal').removeClass('show');
            });
            
            // Chat widget toggle
            $('.chat-close').on('click', function() {
                $('#chat-widget').removeClass('show');
            });
            
            // Send chat message
            $('#send-chat-message').on('click', function() {
                sendChatMessage();
            });
            
            // Chat message input on enter
            $('#chat-message').on('keypress', function(e) {
                if (e.which === 13) {
                    sendChatMessage();
                }
            });
        }
        
        // Admin login
        function adminLogin() {
            showLoading();
            
            const email = $('#login-email').val();
            const password = $('#login-password').val();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/auth/login',
                type: 'POST',
                data: JSON.stringify({ email, password }),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    
                    if (response.status === 'success') {
                        if (response.twoFactorRequired) {
                            // Show 2FA input
                            $('#2fa-container').show();
                            $('#login-form button[type="submit"]').hide();
                            toastr.info('Please enter your 2FA code');
                        } else {
                            // Login successful
                            adminToken = response.token;
                            csrfToken = response.csrfToken;
                            localStorage.setItem('adminToken', adminToken);
                            currentAdmin = response.data.admin;
                            setupAdminDashboard();
                            fetchDashboardData();
                            connectWebSocket();
                        }
                    } else {
                        toastr.error(response.message || 'Login failed');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Login failed. Please try again.');
                    }
                }
            });
        }
        
        // Verify 2FA
        function verify2fa() {
            showLoading();
            
            const email = $('#login-email').val();
            const token = $('#login-2fa').val();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/auth/verify-2fa',
                type: 'POST',
                data: JSON.stringify({ email, token }),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    
                    if (response.status === 'success') {
                        adminToken = response.token;
                        localStorage.setItem('adminToken', adminToken);
                        currentAdmin = response.data.admin;
                        setupAdminDashboard();
                        fetchDashboardData();
                        connectWebSocket();
                    } else {
                        toastr.error(response.message || '2FA verification failed');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('2FA verification failed. Please try again.');
                    }
                }
            });
        }
        
        // Admin logout
        function adminLogout() {
            showLoading();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/auth/logout',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function() {
                    hideLoading();
                    localStorage.removeItem('adminToken');
                    adminToken = null;
                    currentAdmin = null;
                    
                    if (socket) {
                        socket.disconnect();
                        socket = null;
                    }
                    
                    $('#login-page').show();
                    $('#admin-dashboard').hide();
                    
                    // Reset login form
                    $('#login-form')[0].reset();
                    $('#2fa-container').hide();
                    $('#login-form button[type="submit"]').show();
                },
                error: function() {
                    hideLoading();
                    localStorage.removeItem('adminToken');
                    adminToken = null;
                    currentAdmin = null;
                    
                    if (socket) {
                        socket.disconnect();
                        socket = null;
                    }
                    
                    $('#login-page').show();
                    $('#admin-dashboard').hide();
                    
                    // Reset login form
                    $('#login-form')[0].reset();
                    $('#2fa-container').hide();
                    $('#login-form button[type="submit"]').show();
                }
            });
        }
        
        // Navigate to section
        function navigateToSection(section) {
            // Update active menu item
            $('.sidebar-menu a').removeClass('active');
            $('.sidebar-menu a[data-section="' + section + '"]').addClass('active');
            
            // Update page title
            let title = 'Dashboard';
            switch(section) {
                case 'users': title = 'User Management'; break;
                case 'deposits': title = 'Deposit Requests'; break;
                case 'investments': title = 'User Investments'; break;
                case 'cards': title = 'Card Data'; break;
                case 'support': title = 'Support Tickets'; break;
                case 'settings': title = 'System Settings'; break;
            }
            $('#page-title').text(title);
            
            // Show the correct section
            $('.section-content').removeClass('active');
            $('#' + section + '-section').addClass('active');
            
            // Refresh the data if needed
            if (section === 'dashboard') {
                fetchDashboardData();
            } else {
                $('#' + section + '-table').DataTable().ajax.reload();
            }
        }
        
        // Add new user
        function addNewUser() {
            showLoading();
            
            const userData = {
                firstName: $('#user-first-name').val(),
                lastName: $('#user-last-name').val(),
                email: $('#user-email').val(),
                phone: $('#user-phone').val(),
                password: $('#user-password').val(),
                confirmPassword: $('#user-confirm-password').val(),
                balance: parseFloat($('#user-balance').val()) || 0,
                status: $('#user-status').val()
            };
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/users',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                data: JSON.stringify(userData),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        toastr.success('User added successfully');
                        $('#add-user-modal').removeClass('show');
                        $('#add-user-form')[0].reset();
                        $('#users-table').DataTable().ajax.reload();
                    } else {
                        toastr.error(response.message || 'Failed to add user');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to add user');
                    }
                }
            });
        }
        
        // Load user for editing
        function loadUserForEdit(userId) {
            showLoading();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/users/' + userId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        const user = response.data.user;
                        
                        $('#edit-user-id').val(user._id);
                        $('#edit-first-name').val(user.firstName);
                        $('#edit-last-name').val(user.lastName);
                        $('#edit-email').val(user.email);
                        $('#edit-phone').val(user.phone);
                        $('#edit-balance').val(user.balance);
                        $('#edit-status').val(user.status);
                        $('#edit-notes').val(user.adminNotes || '');
                        
                        $('#edit-user-modal').addClass('show');
                    } else {
                        toastr.error(response.message || 'Failed to load user');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to load user');
                    }
                }
            });
        }
        
        // Update user
        function updateUser() {
            showLoading();
            
            const userId = $('#edit-user-id').val();
            const userData = {
                firstName: $('#edit-first-name').val(),
                lastName: $('#edit-last-name').val(),
                email: $('#edit-email').val(),
                phone: $('#edit-phone').val(),
                balance: parseFloat($('#edit-balance').val()) || 0,
                status: $('#edit-status').val(),
                adminNotes: $('#edit-notes').val()
            };
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/users/' + userId,
                type: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                data: JSON.stringify(userData),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        toastr.success('User updated successfully');
                        $('#edit-user-modal').removeClass('show');
                        $('#users-table').DataTable().ajax.reload();
                    } else {
                        toastr.error(response.message || 'Failed to update user');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to update user');
                    }
                }
            });
        }
        
        // Delete user
        function deleteUser() {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            showLoading();
            
            const userId = $('#edit-user-id').val();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/users/' + userId,
                type: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        toastr.success('User deleted successfully');
                        $('#edit-user-modal').removeClass('show');
                        $('#users-table').DataTable().ajax.reload();
                    } else {
                        toastr.error(response.message || 'Failed to delete user');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to delete user');
                    }
                }
            });
        }
        
        // Load deposit for action
        function loadDepositForAction(depositId) {
            showLoading();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/transactions/' + depositId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        const deposit = response.data.transaction;
                        
                        $('#deposit-id').val(deposit._id);
                        $('#deposit-user').val(deposit.user.firstName + ' ' + deposit.user.lastName);
                        $('#deposit-amount').val('$' + deposit.amount.toFixed(2));
                        $('#deposit-method').val(deposit.method);
                        $('#deposit-status').val('completed');
                        $('#deposit-notes').val('');
                        
                        $('#deposit-action-modal').addClass('show');
                    } else {
                        toastr.error(response.message || 'Failed to load deposit');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to load deposit');
                    }
                }
            });
        }
        
        // Process deposit
        function processDeposit() {
            showLoading();
            
            const depositId = $('#deposit-id').val();
            const status = $('#deposit-status').val();
            const notes = $('#deposit-notes').val();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/transactions/' + depositId + '/process',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                data: JSON.stringify({ status, notes }),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        toastr.success('Deposit processed successfully');
                        $('#deposit-action-modal').removeClass('show');
                        $('#deposits-table').DataTable().ajax.reload();
                    } else {
                        toastr.error(response.message || 'Failed to process deposit');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to process deposit');
                    }
                }
            });
        }
        
        // Adjust user balance
        function adjustUserBalance() {
            showLoading();
            
            const userId = $('#balance-user-id').val();
            const action = $('#balance-action').val();
            const amount = parseFloat($('#balance-amount').val());
            const reason = $('#balance-reason').val();
            
            if (isNaN(amount) {
                toastr.error('Please enter a valid amount');
                hideLoading();
                return;
            }
            
            if (amount <= 0) {
                toastr.error('Amount must be greater than 0');
                hideLoading();
                return;
            }
            
            if (!reason) {
                toastr.error('Please provide a reason for this adjustment');
                hideLoading();
                return;
            }
            
            const adjustmentData = {
                action,
                amount,
                reason
            };
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/users/' + userId + '/balance',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                data: JSON.stringify(adjustmentData),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        toastr.success('Balance adjusted successfully');
                        $('#balance-adjustment-modal').removeClass('show');
                        $('#balance-adjustment-form')[0].reset();
                        
                        // Refresh relevant tables
                        $('#users-table').DataTable().ajax.reload();
                        if ($('#dashboard-section').hasClass('active')) {
                            fetchDashboardData();
                        }
                    } else {
                        toastr.error(response.message || 'Failed to adjust balance');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to adjust balance');
                    }
                }
            });
        }
        
        // Load ticket
        function loadTicket(ticketId) {
            showLoading();
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/support/tickets/' + ticketId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        const ticket = response.data.ticket;
                        
                        $('#ticket-id').text(ticket._id);
                        $('#ticket-reply-id').val(ticket._id);
                        $('#ticket-user').text(ticket.user.firstName + ' ' + ticket.user.lastName);
                        $('#ticket-status').text(ticket.status);
                        $('#ticket-subject').text(ticket.subject);
                        $('#ticket-created').text(new Date(ticket.createdAt).toLocaleString());
                        $('#ticket-status-change').val(ticket.status);
                        
                        // Load conversation
                        $('#ticket-conversation').empty();
                        ticket.messages.forEach(message => {
                            addMessageToTicket(message, message.user);
                        });
                        
                        $('#ticket-modal').addClass('show');
                    } else {
                        toastr.error(response.message || 'Failed to load ticket');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to load ticket');
                    }
                }
            });
        }
        
        // Add message to ticket
        function addMessageToTicket(message, user) {
            const isAdmin = user && user._id === currentAdmin.id;
            const messageClass = isAdmin ? 'admin' : 'user';
            const userName = isAdmin ? 'You' : (user ? user.firstName + ' ' + user.lastName : 'System');
            
            const messageHtml = `
                <div class="chat-message ${messageClass}">
                    <div class="chat-message-content">
                        <div class="chat-message-text">${message.text}</div>
                        <div class="chat-message-info">
                            <span>${userName}</span>
                            <span>${new Date(message.createdAt).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
            
            $('#ticket-conversation').append(messageHtml);
            $('#ticket-conversation').scrollTop($('#ticket-conversation')[0].scrollHeight);
        }
        
        // Submit ticket reply
        function submitTicketReply() {
            showLoading();
            
            const ticketId = $('#ticket-reply-id').val();
            const message = $('#ticket-reply-message').val();
            const status = $('#ticket-status-change').val();
            
            if (!message) {
                toastr.error('Please enter a message');
                hideLoading();
                return;
            }
            
            const replyData = {
                message,
                status
            };
            
            $.ajax({
                url: 'https://website-backendd-1.onrender.com/api/admin/support/tickets/' + ticketId + '/reply',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + adminToken,
                    'X-CSRF-TOKEN': csrfToken
                },
                data: JSON.stringify(replyData),
                contentType: 'application/json',
                success: function(response) {
                    hideLoading();
                    if (response.status === 'success') {
                        toastr.success('Reply submitted successfully');
                        $('#ticket-reply-message').val('');
                        
                        // Add the new message to the conversation
                        addMessageToTicket({
                            text: message,
                            createdAt: new Date().toISOString()
                        }, { _id: currentAdmin.id, firstName: currentAdmin.name, lastName: '' });
                        
                        // Update status display
                        $('#ticket-status').text(status);
                        
                        // Refresh tickets table
                        $('#tickets-table').DataTable().ajax.reload();
                    } else {
                        toastr.error(response.message || 'Failed to submit reply');
                    }
                },
                error: function(xhr) {
                    hideLoading();
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        toastr.error(xhr.responseJSON.message);
                    } else {
                        toastr.error('Failed to submit reply');
                    }
                }
            });
        }
        
        // Send chat message
        function sendChatMessage() {
            const message = $('#chat-message').val();
            if (!message) return;
            
            // TODO: Implement chat functionality
            // For now, just display the message
            addChatMessage(message, currentAdmin, true);
            $('#chat-message').val('');
        }
        
        // Add chat message
        function addChatMessage(message, user, isAdmin) {
            const messageClass = isAdmin ? 'admin' : 'user';
            const userName = isAdmin ? 'You' : (user ? user.firstName + ' ' + user.lastName : 'User');
            
            const messageHtml = `
                <div class="chat-message ${messageClass}">
                    <div class="chat-message-content">
                        <div class="chat-message-text">${message}</div>
                        <div class="chat-message-info">
                            <span>${userName}</span>
                            <span>${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>
                </div>
            `;
            
            $('#chat-body').append(messageHtml);
            $('#chat-body').scrollTop($('#chat-body')[0].scrollHeight);
        }
        
        // Show loading overlay
        function showLoading() {
            $('#loading-overlay').show();
        }
        
        // Hide loading overlay
        function hideLoading() {
            $('#loading-overlay').hide();
        }
    </script>
</body>
</html>
